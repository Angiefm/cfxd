variables:
  NODE_ENV: test
  CI: "true"
  NODE_OPTIONS: "--experimental-vm-modules"
  NPM_CONFIG_CACHE: ".npm"

stages:
  - code-quality
  - compile
  - build
  - test
  - coverage
  - deploy

image: node:20-alpine

.default_cache: &default_cache
  key:
    files:
      - package-lock.json
  paths:
    - node_modules/
    - .npm/
  policy: pull

.install_dependencies: &install_dependencies
  before_script:
    - npm ci --cache .npm --prefer-offline

lint:
  stage: code-quality
  cache:
    <<: *default_cache
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run lint
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_MERGE_REQUEST_IID'

format:
  stage: code-quality
  cache:
    <<: *default_cache
  script:
    - npm ci --cache .npm --prefer-offline
    - npm run format:check
  allow_failure: true
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_MERGE_REQUEST_IID'

compile:
  stage: compile
  cache:
    <<: *default_cache
  <<: *install_dependencies
  script:
    - node -e "console.log('ES Modules syntax check passed')"
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_MERGE_REQUEST_IID'

build:
  stage: build
  dependencies:
    - compile
  cache:
    <<: *default_cache
  <<: *install_dependencies
  script:
    - npm run lint
    - npm run format:check
    - npm run build
  artifacts:
    paths:
      - out/
    expire_in: 1 hour
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_MERGE_REQUEST_IID'

test:
  stage: test
  dependencies:
    - build
  cache:
    <<: *default_cache
    paths:
      - node_modules/
      - .npm/
  <<: *install_dependencies
  script:
    - npm test -- --ci --coverage --watchAll=false --passWithNoTests
  artifacts:
    paths:
      - coverage/
    when: always
    expire_in: 1 hour
  coverage: '/^\s*All files[^\n]*\n[^\n]*\n\s*\d+\s+\d+\s+\d+\s+\d+\s+(\d+)%/'
  rules:
    - if: '$CI_COMMIT_BRANCH'
    - if: '$CI_MERGE_REQUEST_IID'

coverage:
   stage: coverage
   dependencies:
     - test
   needs:
     - job: test
       artifacts: true
   script:
     - |
       if [ ! -f "coverage/coverage-summary.json" ]; then
         echo "Coverage file not found!"
         exit 1
       fi
       global_lines=$(node -e "console.log(require('./coverage/coverage-summary.json').total.lines.pct || 0)")
       threshold=70
       echo "Current coverage: ${global_lines}%"
       echo "Required threshold: ${threshold}%"
       if [ $(echo "$global_lines < $threshold" | bc) -eq 1 ]; then
         echo "Coverage is below threshold!"
         exit 1
       else
         echo "Coverage check passed!"
       fi
   rules:
     - if: '$CI_COMMIT_BRANCH'
     - if: '$CI_MERGE_REQUEST_IID'

build_and_push:
   stage: deploy
   image: docker:latest
   services:
     - docker:dind
   variables:
     DOCKER_TLS_CERTDIR: "/certs"
   script:
     - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG .
     - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
     - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
     - |
       if [ "$CI_COMMIT_REF_NAME" = "main" ]; then
         docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG $CI_REGISTRY_IMAGE:latest
         docker push $CI_REGISTRY_IMAGE:latest
       fi
   rules:
     - if: '$CI_COMMIT_BRANCH'
     - if: '$CI_MERGE_REQUEST_IID'
